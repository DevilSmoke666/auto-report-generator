# ==============================================================================
# Makefile –¥–ª—è Auto-Report Generator
#
# –¶–µ–π Makefile –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É—î —Ç–∏–ø–æ–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Ä–æ–∑—Ä–æ–±–∫–∏ —Ç–∞ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –¥–ª—è –≤–∞—à–æ—ó
# Streamlit –ø—Ä–æ–≥—Ä–∞–º–∏, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ —É–∑–≥–æ–¥–∂–µ–Ω—ñ—Å—Ç—å –º—ñ–∂ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞–º–∏, –≤–∫–ª—é—á–∞—é—á–∏
# GitHub Codespaces.
# ==============================================================================

# --- –ó–º—ñ–Ω–Ω—ñ ---
# –í–∏–∑–Ω–∞—á—Ç–µ –Ω–∞–∑–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –≤–∞—à–æ–≥–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
VENV_DIR = venv

# –®–ª—è—Ö –¥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É Python –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
PYTHON_BIN = $(VENV_DIR)/bin/python

# –®–ª—è—Ö –¥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É Streamlit –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
STREAMLIT_BIN = $(VENV_DIR)/bin/streamlit

# –®–ª—è—Ö –¥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É pytest –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
PYTEST_BIN = $(VENV_DIR)/bin/pytest

# –®–ª—è—Ö –¥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É black –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
BLACK_BIN = $(VENV_DIR)/bin/black

# –®–ª—è—Ö –¥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É flake8 –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
FLAKE8_BIN = $(VENV_DIR)/bin/flake8

# Google Cloud Project ID (replace with your actual project ID if needed)
# You might fetch this from gcloud config or set it explicitly
GCP_PROJECT_ID = autoreportbot # <-- –í–ê–ñ–õ–ò–í–û: –ó–ê–ú–Ü–ù–Ü–¢–¨ –ù–ê –í–ê–® –§–ê–ö–¢–ò–ß–ù–ò–ô ID –ü–†–û–Ñ–ö–¢–£ GCP
GCR_IMAGE_NAME = gcr.io/$(GCP_PROJECT_ID)/auto-report
GCP_REGION = europe-west1
CLOUD_RUN_SERVICE_NAME = auto-report

# --- Phony Targets (–∑–∞–ø–æ–±—ñ–≥–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º –∑ —Ñ–∞–π–ª–∞–º–∏ –∑ —Ç–∞–∫–æ—é –∂ –Ω–∞–∑–≤–æ—é) ---
.PHONY: setup run streamlit test format lint unittest build deploy all clean


# --- –û—Å–Ω–æ–≤–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Ä–æ–∑—Ä–æ–±–∫–∏ ---

# setup: –°—Ç–≤–æ—Ä—é—î —Ç–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ, –ø–æ—Ç—ñ–º –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ.
# –¶–µ –º–∞—î –±—É—Ç–∏ –ø–µ—Ä—à–∞ –∫–æ–º–∞–Ω–¥–∞, —è–∫—É –≤–∏ –∑–∞–ø—É—Å–∫–∞—î—Ç–µ –ø—Ä–∏ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é –∞–±–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ Codespace.
setup:
	@echo "‚ú® –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
	@if [ -d "$(VENV_DIR)" ]; then \
		echo "–í–∏–¥–∞–ª—è—î–º–æ —ñ—Å–Ω—É—é—á–µ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: $(VENV_DIR)..."; \
		rm -rf $(VENV_DIR); \
	fi
	@echo "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ —É $(VENV_DIR)..."
	python3 -m venv $(VENV_DIR)
	@echo "–û–Ω–æ–≤–ª–µ–Ω–Ω—è pip —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–º–æ–≥ —É –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ..."
	$(PYTHON_BIN) -m pip install --upgrade pip
	$(PYTHON_BIN) -m pip install -r requirements.txt
	@echo "‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ 'make run'."


# run: –ó–∞–ø—É—Å–∫–∞—î Streamlit –ø—Ä–æ–≥—Ä–∞–º—É –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–º `PYTHONPATH`.
# –¶–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤ Codespaces.
run:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ Streamlit –ø—Ä–æ–≥—Ä–∞–º–∏..."
	PYTHONPATH=. $(STREAMLIT_BIN) run app/run_app.py


# streamlit: –ü—Å–µ–≤–¥–æ–Ω—ñ–º –¥–ª—è —Ç–∞—Ä–≥–µ—Ç—É 'run'.
streamlit: run


# test: –ó–∞–ø—É—Å–∫–∞—î –≤—Å—ñ —Ç–µ—Å—Ç–∏ (–ø–æ–∫–∏ —â–æ –∑–∞–≥–ª—É—à–∫–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–∞—Ä–≥–µ—Ç pytest).
test: unittest


# format: –§–æ—Ä–º–∞—Ç—É—î –∫–æ–¥ Python –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Black.
format:
	@echo "üé® –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∫–æ–¥—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Black..."
	$(BLACK_BIN) . --line-length 100
	@echo "‚úÖ –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ."


# lint: –ü–µ—Ä–µ–≤—ñ—Ä—è—î –∫–æ–¥ Python –Ω–∞ —Å—Ç–∏–ª—å–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Flake8.
lint:
	@echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–¥—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Flake8..."
	$(FLAKE8_BIN) . --ignore=E501
	@echo "‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."


# unittest: –ó–∞–ø—É—Å–∫–∞—î —é–Ω—ñ—Ç-—Ç–µ—Å—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Pytest.
unittest:
	@echo "üß™ –ó–∞–ø—É—Å–∫ —é–Ω—ñ—Ç-—Ç–µ—Å—Ç—ñ–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Pytest..."
	PYTHONPATH=./ $(PYTEST_BIN) tests/
	@echo "‚úÖ –Æ–Ω—ñ—Ç-—Ç–µ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."


# project: –ó–∞–ø—É—Å–∫–∞—î —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è, –ª—ñ–Ω—Ç–∏–Ω–≥, —é–Ω—ñ—Ç-—Ç–µ—Å—Ç–∏, –∞ –ø–æ—Ç—ñ–º –∑–∞–ø—É—Å–∫–∞—î Streamlit.
project: format lint unittest run


# --- –ó–∞–≤–¥–∞–Ω–Ω—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è Google Cloud ---

# build: –°—Ç–≤–æ—Ä—é—î –æ–±—Ä–∞–∑ Docker —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –π–æ–≥–æ –¥–æ Google Container Registry (GCR).
build:
	@echo "üì¶ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±—Ä–∞–∑—É Docker —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ GCR: $(GCR_IMAGE_NAME)..."
	gcloud builds submit --tag $(GCR_IMAGE_NAME) .
	@echo "‚úÖ –û–±—Ä–∞–∑ Docker —Å—Ç–≤–æ—Ä–µ–Ω–æ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ."

# deploy: –†–æ–∑–≥–æ—Ä—Ç–∞—î –ø—Ä–æ–≥—Ä–∞–º—É –≤ Google Cloud Run.
deploy:
	@echo "üöÄ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –¥–æ —Å–µ—Ä–≤—ñ—Å—É Google Cloud Run: $(CLOUD_RUN_SERVICE_NAME) —É —Ä–µ–≥—ñ–æ–Ω—ñ $(GCP_REGION)..."
	gcloud run deploy $(CLOUD_RUN_SERVICE_NAME) \
		--image $(GCR_IMAGE_NAME) \
		--platform managed \
		--region $(GCP_REGION) \
		--allow-unauthenticated
	@echo "‚úÖ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –¥–æ Cloud Run –∑–∞–≤–µ—Ä—à–µ–Ω–æ."


# all: –í–∏–∫–æ–Ω—É—î –ø–æ–≤–Ω—É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –∑–±—ñ—Ä–∫–∏ —Ç–∞ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è.
all: build deploy


# --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è ---

# clean: –û—á–∏—â–∞—î –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ –∑–±—ñ—Ä–∫–∏ —Ç–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ.
clean:
	@echo "üßπ –û—á–∏—â–µ–Ω–Ω—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ —Ç–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞..."
	rm -rf $(VENV_DIR)
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	@echo "‚úÖ –û—á–∏—â–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ."